# firEtcd æ¼”ç¤ºé¡¹ç›® Makefile

.PHONY: help build start stop test clean demo

# é»˜è®¤ç›®æ ‡
help:
	@echo "ğŸš€ firEtcd æœåŠ¡å‘ç°æ¼”ç¤ºé¡¹ç›®"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  make build      - æ„å»º firEtcd äºŒè¿›åˆ¶æ–‡ä»¶"
	@echo "  make start      - å¯åŠ¨ firEtcd é›†ç¾¤"
	@echo "  make stop       - åœæ­¢ firEtcd é›†ç¾¤"
	@echo "  make test       - è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•"
	@echo "  make demo       - å¯åŠ¨å®Œæ•´æ¼”ç¤º"
	@echo "  make clean      - æ¸…ç†æ¼”ç¤ºç¯å¢ƒ"
	@echo "  make health     - æ£€æŸ¥é›†ç¾¤å¥åº·çŠ¶æ€"
	@echo ""

# æ„å»º firEtcd
build:
	@echo "ğŸ”¨ æ„å»º firEtcd..."
	cd .. && make build
	@echo "âœ… æ„å»ºå®Œæˆ"

# å¯åŠ¨é›†ç¾¤
start: build
	@echo "ğŸš€ å¯åŠ¨ firEtcd é›†ç¾¤..."
	@chmod +x scripts/*.sh
	./scripts/start-cluster.sh
	@echo "âœ… é›†ç¾¤å¯åŠ¨å®Œæˆ"

# åœæ­¢é›†ç¾¤
stop:
	@echo "ğŸ›‘ åœæ­¢ firEtcd é›†ç¾¤..."
	./scripts/stop-cluster.sh
	@echo "âœ… é›†ç¾¤å·²åœæ­¢"

# å¥åº·æ£€æŸ¥
health:
	@echo "ğŸ¥ æ£€æŸ¥é›†ç¾¤å¥åº·çŠ¶æ€..."
	./scripts/health-check.sh

# è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
test: start
	@echo "ğŸ§ª è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•..."
	@echo "ç­‰å¾…é›†ç¾¤ç¨³å®š..."
	@sleep 10
	go test ./tests/ -v -run "TestE2E"
	@echo "âœ… æµ‹è¯•å®Œæˆ"

# è¿è¡Œæ€§èƒ½æµ‹è¯•
test-performance: start
	@echo "ğŸ“Š è¿è¡Œæ€§èƒ½æµ‹è¯•..."
	@echo "ç­‰å¾…é›†ç¾¤ç¨³å®š..."
	@sleep 10
	go test ./tests/ -v -run "TestE2EPerformance"
	@echo "âœ… æ€§èƒ½æµ‹è¯•å®Œæˆ"

# å¯åŠ¨å®Œæ•´æ¼”ç¤º
demo: start
	@echo "ğŸ¬ å¯åŠ¨å®Œæ•´æ¼”ç¤º..."
	@echo ""
	@echo "ğŸ“‹ æ¼”ç¤ºæ­¥éª¤:"
	@echo "1. é›†ç¾¤å·²å¯åŠ¨ï¼Œç­‰å¾…ç¨³å®š..."
	@sleep 5
	@echo "2. å¯åŠ¨ç”¨æˆ·æœåŠ¡ (ç«¯å£ 8083)..."
	@echo "   æ–°å¼€ç»ˆç«¯è¿è¡Œ: go run ./services/user-service/main.go"
	@echo ""
	@echo "3. å¯åŠ¨è®¢å•æœåŠ¡ (ç«¯å£ 8084)..."
	@echo "   æ–°å¼€ç»ˆç«¯è¿è¡Œ: go run ./services/order-service/main.go"
	@echo ""
	@echo "4. å¯åŠ¨ API ç½‘å…³ (ç«¯å£ 8080)..."
	@echo "   æ–°å¼€ç»ˆç«¯è¿è¡Œ: go run ./services/gateway-service/main.go"
	@echo ""
	@echo "5. è¿è¡Œå®¢æˆ·ç«¯æ¼”ç¤º..."
	@echo "   æ–°å¼€ç»ˆç«¯è¿è¡Œ: go run ./client/service-client.go"
	@echo ""
	@echo "6. æµ‹è¯• HTTP API..."
	@echo "   å¥åº·æ£€æŸ¥: curl http://localhost:8080/health"
	@echo "   æœåŠ¡çŠ¶æ€: curl http://localhost:8080/status"
	@echo "   æœåŠ¡å‘ç°: curl http://localhost:8080/api/discovery"
	@echo ""
	@echo "ğŸ¯ æ¼”ç¤ºå·²å‡†å¤‡å°±ç»ªï¼"

# å¯åŠ¨å•ä¸ªæœåŠ¡
user-service: start
	@echo "ğŸ‘¤ å¯åŠ¨ç”¨æˆ·æœåŠ¡..."
	go run ./services/user-service/main.go

order-service: start
	@echo "ğŸ“¦ å¯åŠ¨è®¢å•æœåŠ¡..."
	go run ./services/order-service/main.go

gateway: start
	@echo "ğŸŒ å¯åŠ¨ API ç½‘å…³..."
	go run ./services/gateway-service/main.go

client-demo: start
	@echo "ğŸ¯ å¯åŠ¨å®¢æˆ·ç«¯æ¼”ç¤º..."
	@sleep 5
	go run ./client/service-client.go

# æ¸…ç†æ¼”ç¤ºç¯å¢ƒ
clean:
	@echo "ğŸ§¹ æ¸…ç†æ¼”ç¤ºç¯å¢ƒ..."
	./scripts/stop-cluster.sh
	rm -rf logs data
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å¿«é€Ÿæ¼”ç¤ºï¼ˆè‡ªåŠ¨åŒ–ï¼‰
quick-demo: start
	@echo "âš¡ å¿«é€Ÿæ¼”ç¤ºæ¨¡å¼..."
	@echo "ç­‰å¾…é›†ç¾¤å¯åŠ¨..."
	@sleep 10
	@echo "è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•..."
	go test ./tests/ -v -run "TestE2E" -timeout 2m
	@echo "âœ… å¿«é€Ÿæ¼”ç¤ºå®Œæˆ"

# ç›‘æ§æ¨¡å¼
monitor: start
	@echo "ğŸ‘€ ç›‘æ§æ¨¡å¼å¯åŠ¨..."
	@echo "é›†ç¾¤å·²å¯åŠ¨ï¼Œå¼€å§‹ç›‘æ§..."
	@echo "æŒ‰ Ctrl+C åœæ­¢ç›‘æ§"
	@trap 'make stop' INT; \
	while true; do \
		clear; \
		echo "=== firEtcd é›†ç¾¤ç›‘æ§ ==="; \
		echo "æ—¶é—´: $$(date)"; \
		echo ""; \
		./scripts/health-check.sh; \
		echo ""; \
		echo "æŒ‰ Ctrl+C åœæ­¢ç›‘æ§"; \
		sleep 10; \
	done 